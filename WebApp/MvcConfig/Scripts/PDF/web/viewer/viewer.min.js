var preli = document.getElementById("prediv");
var current = 0;
var stop = 0, left = 0;
var f = document.getElementById("father");
var scale = "", rotate="";



  var params = {
      zoomVal:1,
      left: 0,
      top: 0,
      currentX: 0,
      currentY: 0,
      flag: false
  };
  function serpreli() {
      var o = document.getElementById("imgpresent");
      if (o.clientHeight == 0) {
          var pre = parseInt(((o.clientWidth * params.zoomVal) / oriwidth) * 100) + "%";
          preli.innerHTML = pre;
      } else {
          var pre = parseInt(((o.clientHeight * params.zoomVal) / oriheight) * 100) + "%";
          preli.innerHTML = pre;
      }
  }
  window.onresize = function () {
      setTimeout(function () {
          serpreli();
      },500);
  }

//图片缩放
function bbimg(o){
    var o = document.getElementById("box");
    params.zoomVal += event.wheelDelta / 1200;
    if (params.zoomVal >= 0.25) {
        serpreli();
        scale="scale("+params.zoomVal+")";
        o.style.transform = scale + rotate;
    } else {      
        params.zoomVal = 0.2;
        serpreli();        
        scale="scale("+params.zoomVal+")";
        o.style.transform = scale+rotate;     
    }
}

function addwheel() {
    var o = document.getElementById("box");
    params.zoomVal += 0.1;
    if (params.zoomVal >= 0.21) {
        serpreli();
        scale="scale("+params.zoomVal+")";
        o.style.transform = scale+rotate;
    } else {
        params.zoomVal = 0.2;
        serpreli();
        scale="scale("+params.zoomVal+")";
        o.style.transform = scale+rotate;
    }
}

function minuswheel() {
    var o = document.getElementById("box");
    params.zoomVal -= 0.1;
    if (params.zoomVal >= 0.21) {
        serpreli();
        scale="scale("+params.zoomVal+")";
        o.style.transform = scale+rotate;
    } else {
        params.zoomVal = 0.2;
        serpreli();
        scale="scale("+params.zoomVal+")";
        o.style.transform = scale+rotate;
    }
}
function getPosx(o) //取元素坐标 
{
    var x = 0;
    do {
        x += o.offsetLeft;
    } while (o = o.offsetParent);
    return x;
}
function getPosy(o) //取元素坐标 
{
    var  y = 0;
    do {
        y += o.offsetTop;
    } while (o = o.offsetParent);
    return y;
}
function reset() {
    var o = document.getElementById("box");
    params.zoomVal = 1;
    
    scale="scale("+params.zoomVal+")";
    current = (current + 90) % 360;
    s = document.getElementById("imgpresent");
    var imgh = document.getElementById("imgpreviewhiddle");
    rotate = ' rotate(' + current + 'deg)';
    o.style.transform = scale + rotate;
    if (imgh.width > imgh.height) {
        if (current % 180 == 0) {
            s.style.width = (f.clientWidth * 0.7) + "px";
            s.style.height = "auto";
            stop = ((f.clientHeight - s.clientHeight) / 2);
            left = ((f.clientWidth - s.clientWidth) / 2);
        } else {
            s.style.width = f.clientHeight * 0.7 + "px";
            s.style.height = "auto";
            stop = ((f.clientHeight - s.clientWidth) / 2);
            left = ((f.clientWidth - s.clientHeight) / 2);
        }
    } 
    
    o.style.top = 0 + "px";
    o.style.left = 0 + "px";
    params.left = 0;
    params.top = 0;
    serpreli();
}
//获取相关CSS属性
var getCss = function(o,key){
    return o.currentStyle? o.currentStyle[key] : document.defaultView.getComputedStyle(o,false)[key];
};
//拖拽的实现
var startDrag = function (bar, target, callback) {
    
    if(getCss(target, "left") !== "auto"){
        params.left = getCss(target, "left");
    }
    if(getCss(target, "top") !== "auto"){
        params.top = getCss(target, "top");
    }
    //o是移动对象
    bar.onmousedown = function (event) {
        params.flag = true;
        if(!event){
            event = window.event;
            //防止IE文字选中
            bar.onselectstart = function(){
                return false;
            }
        }
        var e = event;
        params.currentX = e.clientX;
        params.currentY = e.clientY;
    };
    document.onmouseup = function(){
        params.flag = false;
        if(getCss(target, "left") !== "auto"){
            params.left = getCss(target, "left");
        }
        if(getCss(target, "top") !== "auto"){
            params.top = getCss(target, "top");
        }
    };
    document.onmousemove = function (event) {
        var e = event ? event: window.event;
        if(params.flag){
            var nowX = e.clientX, nowY = e.clientY;
            var disX = nowX - params.currentX, disY = nowY - params.currentY;
            target.style.left = parseInt(params.left) + disX+ "px";
            target.style.top = parseInt(params.top) + disY+ "px";
            if (typeof callback == "function") {
                callback((parseInt(params.left) || 0) + disX, (parseInt(params.top) || 0) + disY);
            }
            if (event.preventDefault) {
                event.preventDefault();
            }
            return false;
        }
    }
};
startDrag(document.getElementById("box"), document.getElementById("box"))
